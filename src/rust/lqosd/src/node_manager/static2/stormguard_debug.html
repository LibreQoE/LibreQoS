<div class="row">
    <div class="col-12 col-xl-10 col-xxl-8">
        <div class="d-flex align-items-center flex-wrap gap-2 mb-3">
            <h5 class="mb-0">
                <i class="fa fa-cloud-bolt me-2 text-primary"></i>StormGuard Debug
            </h5>
            <span class="badge bg-secondary" id="sg-status">Connecting…</span>
            <span class="text-muted small" id="sg-updated">Waiting for data</span>
        </div>
        <p class="text-muted mb-3">
            Live StormGuard target rates (download/upload Mbps) as reported by lqosd.
            Values reflect the limits StormGuard believes are active on each monitored site.
        </p>

        <div class="card shadow-sm mb-3">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm align-middle mb-0">
                        <thead class="table-light">
                            <tr>
                                <th scope="col"><i class="fa fa-sitemap me-1"></i>Site</th>
                                <th scope="col"><i class="fa fa-arrow-down me-1 text-primary"></i>Download (Mbps)</th>
                                <th scope="col"><i class="fa fa-arrow-up me-1 text-success"></i>Upload (Mbps)</th>
                            </tr>
                        </thead>
                        <tbody id="sg-table">
                            <tr>
                                <td colspan="3" class="text-muted">Waiting for StormGuardStatus feed…</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="alert alert-info small mb-0">
            <i class="fa fa-info-circle me-1"></i>
            Data is streamed from the <code>StormguardStatus</code> channel; rates shown are the current HTB limits StormGuard is enforcing.
        </div>
    </div>
</div>

<script>
(function () {
    const statusBadge = document.getElementById("sg-status");
    const updated = document.getElementById("sg-updated");
    const table = document.getElementById("sg-table");

    function wsProto() {
        return window.location.protocol.startsWith("https") ? "wss://" : "ws://";
    }

    function setStatus(label, cls) {
        statusBadge.textContent = label;
        statusBadge.className = "badge " + cls;
    }

    function renderRows(rows) {
        if (!Array.isArray(rows) || rows.length === 0) {
            table.innerHTML = '<tr><td colspan="3" class="text-muted">No StormGuard data available.</td></tr>';
            return;
        }

        table.innerHTML = rows
            .map((row) => {
                const site = row[0] ?? "Unknown";
                const down = row[1] ?? 0;
                const up = row[2] ?? 0;
                return `
                    <tr>
                        <td class="fw-semibold">${site}</td>
                        <td>${Number(down).toLocaleString()}</td>
                        <td>${Number(up).toLocaleString()}</td>
                    </tr>
                `;
            })
            .join("");
    }

    function connect() {
        setStatus("Connecting…", "bg-secondary");
        const ws = new WebSocket(wsProto() + window.location.host + "/websocket/ws");

        ws.onopen = () => {
            setStatus("Live", "bg-success");
            ws.send('{ "channel" : "StormguardStatus"}');
        };

        ws.onclose = () => {
            setStatus("Disconnected", "bg-warning");
            setTimeout(connect, 3000);
        };

        ws.onerror = () => {
            setStatus("Error", "bg-danger");
            ws.close();
        };

        ws.onmessage = (event) => {
            try {
                const msg = JSON.parse(event.data);
                if (msg && msg.event === "StormguardStatus") {
                    renderRows(msg.data || []);
                    updated.textContent = "Updated " + new Date().toLocaleTimeString();
                }
            } catch (err) {
                console.error("Failed to parse StormGuardStatus message", err);
            }
        };
    }

    connect();
})();
</script>
