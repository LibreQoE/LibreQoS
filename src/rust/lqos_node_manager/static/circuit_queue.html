<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="/vendor/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/vendor/solid.min.css">
    <link rel="stylesheet" href="/lqos.css">
    <title>LibreQoS - Local Node Manager</title>
    <script src="/lqos.js"></script>
    <script src="/vendor/plotly-2.16.1.min.js"></script>
    <script src="/vendor/jquery.min.js"></script><script src="/vendor/msgpack.min.js"></script>
    <script defer src="/vendor/bootstrap.bundle.min.js"></script>
</head>
<body class="bg-secondary">
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/"><img src="/vendor/tinylogo.svg" alt="LibreQoS SVG Logo" width="25" height="25" />&nbsp;LibreQoS</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarSupportedContent">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item">
                        <a class="nav-link" href="/tree?parent=0"><i class="fa fa-tree"></i> Tree</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" aria-current="page" href="/shaped"><i class="fa fa-users"></i> Shaped Devices <span id="shapedCount" class="badge badge-pill badge-success green-badge">?</span></a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/unknown"><i class="fa fa-address-card"></i> Unknown IPs <span id="unshapedCount" class="badge badge-warning orange-badge">?</span></a>
                    </li>
                </ul>
            </div>

            <ul class="navbar-nav ms-auto">
                <li class="nav-item" id="currentLogin"></li>
                <li class="nav-item">
                    <a class="nav-link" href="#" id="startTest"><i class="fa fa-flag-checkered"></i> Run Bandwidth Test</a>
                </li>
                <li class="nav-item ms-auto">
                    <a class="nav-link" href="/config"><i class="fa fa-gear"></i> Configuration</a>
                </li>
                <li>
                    <a class="nav-link btn btn-small black-txt" href="#" id="btnReload"><i class="fa fa-refresh"></i> Reload LibreQoS</a>
                </li>
            </ul>
        </div>
    </nav>

    <div id="container" class="pad4">

        <div class="row top-shunt">
            <div class="col-sm-12 bg-light center-txt">
                <div class="row">
                    <div class="col-sm-4">
                        <span id="circuitName" class="bold redact"></span>
                    </div>
                    <div class="col-sm-6">
                        <ul class="nav nav-pills mb-3" id="pills-tab" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="pills-home-tab" data-bs-toggle="pill" data-bs-target="#pills-home" type="button" role="tab" aria-controls="pills-home" aria-selected="true">Overview</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="pills-tins-tab" data-bs-toggle="pill" data-bs-target="#pills-tins" type="button" role="tab" aria-controls="pills-profile" aria-selected="false">All Tins</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="pills-funnel-tab" data-bs-toggle="pill" data-bs-target="#pills-funnel" type="button" role="tab" aria-controls="pills-funnel" aria-selected="false">Queue Tree</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="pills-flows-tab" data-bs-toggle="pill" data-bs-target="#pills-flows" type="button" role="tab" aria-controls="pills-flows" aria-selected="false">Flows</button>
                            </li>
                        </ul>
                    </div>
                    <div class="col-sm-2">
                    <div id="raw"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-content" id="pills-tabContent">
            <div class="tab-pane fade show active" id="pills-home" role="tabpanel" aria-labelledby="pills-home-tab" tabindex="0">

                <!-- Total Throughput and Backlog -->
                <div class="row">
                    <div class="col-sm-4">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h5 class="card-title"><i class="fa fa-dashboard"></i> Throughput</h5>
                                <div id="throughputGraph" class="graph150"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-sm-4">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h5 class="card-title"><i class="fa fa-car"></i> Backlog</h5>
                                <div id="backlogGraph" class="graph150"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-sm-4">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h5 class="card-title"><i class="fa fa-bar-chart"></i> Capacity Quantile</h5>
                                <div id="capacityQuantile" class="graph150"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Delay and Queue Length -->
                <div class="row mtop4">
                    <div class="col-sm-6">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h5 class="card-title"><i class="fa fa-hourglass"></i> Delays</h5>
                                <div id="delayGraph" class="graph150"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-sm-6">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h5 class="card-title"><i class="fa fa-fast-forward"></i> Queue Length</h5>
                                <div id="qlenGraph" class="graph150"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row mtop4">
                    <div class="col-sm-2">
                        <div class="card bg-light">
                            <div class="card-body">
                                Queue Memory: <span id="memory"></span>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
            <div class="tab-pane fade" id="pills-tins" role="tabpanel" aria-labelledby="pills-tins-tab" tabindex="1">
                <div class="row" class="mtop4">
                    <div class="col-sm-6">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h5 class="card-title"><i class="fa fa-truck"></i> Tin 1 (Bulk)</h5>
                                <div id="tinTp_0" class="graph150"></div>
                                <div id="tinMd_0" class="graph150"></div>
                            </div>                        
                        </div>
                    </div>
                    <div class="col-sm-6">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h5 class="card-title"><i class="fa fa-balance-scale"></i> Tin 2 (Best Effort)</h5>
                                <div id="tinTp_1" class="graph150"></div>
                                <div id="tinMd_1" class="graph150"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row mtop4">
                    <div class="col-sm-6">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h5 class="card-title"><i class="fa fa-television"></i> Tin 3 (Video)</h5>
                                <div id="tinTp_2" class="graph150"></div>
                                <div id="tinMd_2" class="graph150"></div>
                            </div>                        
                        </div>
                    </div>
                    <div class="col-sm-6">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h5 class="card-title"><i class="fa fa-phone"></i> Tin 4 (Voice)</h5>
                                <div id="tinTp_3" class="graph150"></div>
                                <div id="tinMd_3" class="graph150"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="pills-funnel" role="tabpanel" aria-labelledby="pills-funnel-tab" tabindex="2">
            </div>

            <div class="tab-pane fade" id="pills-flows" role="tabpanel" aria-labelledby="pills-flows-tab" tabindex="3">
                <div class="row">
                    <div class="col-sm12">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h5 class="card-title"><i class="fa fa-bar-chart"></i> Flows (Last 30 Seconds)</h5>
                                <p class="alert alert-warning" role="alert">
                                    <i class="fa fa-warning"></i> Gathering packet data can cause high CPU load during the capture window.
                                </p>
                                <div id="packetButtons"></div>
                                <div id="flowList"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
          </div>          
    </div>

    <footer>&copy; 2022-2023, LibreQoE LLC</footer>

    <script>
        let throughput = new Object();
        let throughput_head = 0;
        let circuit_info = null;

        function setX(x, counter) {
            for (let i=0; i<x.length; i++) {
                x[i].push(counter);
            }
        }

        function setY(y, i, data, tin) {
            if (data[0] == "None" || data[1] == "None") {
                for (let j=0; i<y.length; y++) {
                    y[j].push(0);
                }
            } else {
                y[0].push(data[0].Cake.tins[tin].sent_bytes * 8); // Download
                y[1].push(0.0 - (data[1].Cake.tins[tin].sent_bytes * 8)); // Upload
                y[2].push(data[0].Cake.tins[tin].drops); // Down Drops
                y[3].push(data[0].Cake.tins[tin].marks); // Down Marks
                y[4].push(0.0 - data[1].Cake.tins[tin].drops); // Up Drops
                y[5].push(0.0 - data[1].Cake.tins[tin].marks); // Up Marks

                // Backlog
                y[6].push(data[0].Cake.tins[tin].backlog_bytes * 8);
                y[7].push(0.0 - data[1].Cake.tins[tin].backlog_bytes * 8);

                // Delays
                y[8].push(data[0].Cake.tins[tin].avg_delay_us);
                y[9].push(0.0 - data[1].Cake.tins[tin].avg_delay_us);
            }
        }

        function pollQueue() {
            const params = new Proxy(new URLSearchParams(window.location.search), {
                get: (searchParams, prop) => searchParams.get(prop),
            });
            if (params.id != null) {
                // Name the circuit
                if (circuit_info == null) {
                    $.get("/api/circuit_info/" + encodeURI(params.id), (data) => {
                        circuit_info = data;
                        let capacity = scaleNumber(circuit_info.capacity[0]) + " / " + scaleNumber(circuit_info.capacity[1]);
                        $("#circuitName").text(redactText(circuit_info.name) + " " + capacity);
                    });
                }

                // Fill the raw button
                $("#raw").html("<a class='btn btn-sm btn-info' href='/api/raw_queue_by_circuit/" + encodeURI(params.id) + "'><i class='fa fa-search'></i> Raw Data</a>");

                // Graphs
                $.get("/api/raw_queue_by_circuit/" + encodeURI(params.id), (data) => {
                    // Fill Base Information
                    let total_memory = data.current_download.Cake.memory_used + data.current_upload.Cake.memory_used;
                    $("#memory").text(scaleNumber(total_memory));

                    // Fill Tin Graphs
                    let backlogX1 = [];
                    let backlogY1 = [];
                    let backlogX2 = [];
                    let backlogY2 = [];
                    let delaysX1 = [];
                    let delaysX2 = [];
                    let delaysY1 = [];
                    let delaysY2 = [];
                    let qlenX1 = [];
                    let qlenY1 = [];
                    let qlenX2 = [];
                    let qlenY2 = [];

                    for (let tin=0; tin<4; tin++) {
                        let entries = {
                            x: [[], [], [], [], [], [], [], [], [], []],
                            y: [[], [], [], [], [], [], [], [], [], []],
                        }
                        let counter = 0;
                        for (let i=data.history_head; i<600; i++) {
                            setX(entries.x, counter);
                            setY(entries.y, i, data.history[i], tin);
                            if (tin == 0) {
                                qlenX1.push(counter);
                                qlenX2.push(counter);
                                if (data.history[i][0].Cake) {
                                    qlenY1.push(data.history[i][0].Cake.qlen);
                                } else {
                                    qlenY1.push(0);
                                }
                                if (data.history[i][1].Cake) {
                                    qlenY2.push(0.0 - data.history[i][1].Cake.qlen);
                                } else {
                                    qlenY2.push(0.0);
                                }
                            }
                            counter++;
                        }
                        for (let i=0; i<data.history_head; i++) {
                            setX(entries.x, counter);
                            setY(entries.y, i, data.history[i], tin);
                            if (tin == 0) {
                                qlenX1.push(counter);
                                qlenX2.push(counter);
                                if (data.history[i][0].Cake) {
                                    qlenY1.push(data.history[i][0].Cake.qlen);
                                } else {
                                    qlenY1.push(0.0);
                                }
                                if (data.history[i][1].Cake) {
                                    qlenY2.push(0.0 - data.history[i][1].Cake.qlen);
                                } else {
                                    qlenY2.push(0.0);
                                }
                            }
                            counter++;                            
                        }
                        let graph = document.getElementById("tinTp_" + tin);
                        let graph_data = [
                            {x: entries.x[0], y:entries.y[0].reverse(), name: 'Download', type: 'scatter'},
                            {x: entries.x[1], y:entries.y[1].reverse(), name: 'Upload', type: 'scatter'},
                        ];
                        Plotly.newPlot(graph, graph_data, { margin: { l:0,r:0,b:0,t:0,pad:4 }, yaxis: { automargin: true, title: "Bits" }, xaxis: {automargin: true, title: "Time since now"} });

                        // Try to hide zeroes
                        for (let i=0; i<entries.y[2].length; i++) {
                            if (entries.y[2][i] == 0) entries.y[2][i] = null;
                            if (entries.y[3][i] == 0) entries.y[3][i] = null;
                            if (entries.y[4][i] == 0) entries.y[4][i] = null;
                            if (entries.y[5][i] == 0) entries.y[5][i] = null;
                        }

                        let mdx = zip(entries.x[2], entries.x[4]);
                        let drop = zip(entries.y[2].reverse(), entries.y[4].reverse());
                        let mark = zip(entries.y[3].reverse(), entries.y[4].reverse());

                        graph = document.getElementById("tinMd_" + tin);
                        graph_data = [
                            {x: mdx, y:drop, name: 'Drops', mode: 'markers', marker: { size: 4 }},
                            {x: mdx, y:mark, name: 'Marks', mode: 'markers', marker: { size: 4 }},
                            //{x: entries.x[4], y:entries.y[4].reverse(), name: 'Up Drops', mode: 'markers', marker: { size: 4 }},
                            //{x: entries.x[5], y:entries.y[5].reverse(), name: 'Up Marks', mode: 'markers', marker: { size: 4 }},
                        ];
                        Plotly.newPlot(graph, graph_data, { margin: { l:0,r:0,b:0,t:0,pad:4 }, yaxis: { automargin: true, title: "Packets" }, xaxis: {automargin: true, title: "Time since now"} });

                        backlogX1.push(entries.x[6]);
                        backlogX2.push(entries.x[7]);
                        backlogY1.push(entries.y[6]);
                        backlogY2.push(entries.y[7]);
                        delaysX1.push(entries.x[8]);
                        delaysX2.push(entries.x[9]);
                        delaysY1.push(entries.y[8]);
                        delaysY2.push(entries.y[9]);
                    }
                    let graph = document.getElementById("backlogGraph");
                    let blx = zip(backlogX1[0], backlogX2[0]);
                    let bly = [
                        zip(backlogY1[0].reverse(), backlogY2[0].reverse()),
                        zip(backlogY1[1].reverse(), backlogY2[1].reverse()),
                        zip(backlogY1[2].reverse(), backlogY2[2].reverse()),
                        zip(backlogY1[3].reverse(), backlogY2[3].reverse()),
                    ]
                    let graph_data = [
                        {x: blx, y:bly[0], type: 'scatter', mode: 'markers', name: 'Bulk'},
                        //{x: blx, y:backlogY2[0].reverse(), type: 'scatter', mode: 'markers', name: 'Tin 0 Up'},
                        {x: blx, y:bly[1], type: 'scatter', mode: 'markers', name: 'Best Effort'},
                        //{x: blx, y:backlogY2[1].reverse(), type: 'scatter', mode: 'markers', name: 'Tin 1 Up'},
                        {x: blx, y:bly[2], type: 'scatter', mode: 'markers', name: 'Video'},
                        //{x: blx, y:backlogY2[2].reverse(), type: 'scatter', mode: 'markers', name: 'Tin 2 Up'},
                        {x: blx, y:bly[3], type: 'scatter', mode: 'markers', name: 'Voice'},
                        //{x: blx, y:backlogY2[3].reverse(), type: 'scatter', mode: 'markers', name: 'Tin 3 Up'},
                    ];
                    Plotly.newPlot(graph, graph_data, { margin: { l:0,r:0,b:0,t:0,pad:4 }, yaxis: { automargin: true, title: "Bytes" }, xaxis: {automargin: true, title: "Time since now (seconds)"} });

                    let dlx = zip(delaysX1[0], delaysX2[0]);
                    let dly = [
                        zip(delaysY1[0].reverse(), delaysY2[0].reverse()),
                        zip(delaysY1[1].reverse(), delaysY2[1].reverse()),
                        zip(delaysY1[2].reverse(), delaysY2[2].reverse()),
                        zip(delaysY1[3].reverse(), delaysY2[3].reverse()),
                    ]
                    graph = document.getElementById("delayGraph");
                    graph_data = [
                        {x: dlx, y:dly[0], type: 'scatter', mode: 'markers', name: 'Tin 0'},
                        //{x: delaysX2[0], y:delaysY2[0].reverse(), type: 'scatter', name: 'Tin 0 Up'},
                        {x: dlx, y:dly[1], type: 'scatter', mode: 'markers', name: 'Tin 1'},
                        //{x: delaysX2[1], y:delaysY2[1].reverse(), type: 'scatter', name: 'Tin 1 Up'},
                        {x: dlx, y:dly[2], type: 'scatter', mode: 'markers', name: 'Tin 2'},
                        //{x: delaysX2[2], y:delaysY2[2].reverse(), type: 'scatter', name: 'Tin 2 Up'},
                        {x: dlx, y:dly[3], type: 'scatter', mode: 'markers', name: 'Tin 3'},
                        //{x: delaysX2[3], y:delaysY2[3].reverse(), type: 'scatter', name: 'Tin 3 Up'},
                    ];
                    Plotly.newPlot(graph, graph_data, { margin: { l:0,r:0,b:0,t:0,pad:4 }, yaxis: { automargin: true, title: "Time (ms)" }, xaxis: {automargin: true, title: "Time since now (seconds)"} });

                    graph = document.getElementById("qlenGraph");
                    graph_data = [
                        {x: qlenX1, y:qlenY1.reverse(), type: 'scatter', name: 'Down'},
                        {x: qlenX2, y:qlenY2.reverse(), type: 'scatter', name: 'Up'},
                    ];
                    Plotly.newPlot(graph, graph_data, { margin: { l:0,r:0,b:0,t:0,pad:4 }, yaxis: { automargin: true, title: "Packets" }, xaxis: {automargin: true, title: "Time since now (seconds)"} });
                });
            }
        }

        let ips = [];

        function getThroughput() {
            const params = new Proxy(new URLSearchParams(window.location.search), {
                get: (searchParams, prop) => searchParams.get(prop),
            });
            if (params.id != null) {
                $.get("/api/circuit_throughput/" + encodeURI(params.id), (data) => {
                    let quantiles = [
                        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                        [0, 10, 20, 30, 40, 50, 60, 70, 80, 90, 100],
                    ];                    

                    ips = [];
                    for (let i=0; i<data.length; i++) {
                        let ip = data[i][0];
                        ips.push(ip);
                        let down = data[i][1];
                        let up = data[i][2];

                        if (throughput[ip] == null) {
                            throughput[ip] = {
                                down: [],
                                up: [],
                            };
                            for (let j=0; j<300; j++) {
                                throughput[ip].down.push(0);
                                throughput[ip].up.push(0);
                            }
                        }
                        throughput[ip].down[throughput_head] = down * 8;
                        throughput[ip].up[throughput_head] = up * 8;
                    }

                    // Build the graph
                    let graph = document.getElementById("throughputGraph");
                    let graph_data = [];
                    for (const ip in throughput) {
                        //console.log(ip);
                        let xUp = [];
                        let xDown = [];
                        let yUp = [];
                        let yDown = [];
                        let counter = 0;
                        for (let i=throughput_head; i<300; i++) {
                            xUp.push(counter);
                            xDown.push(counter);
                            yUp.push(0.0 - throughput[ip].up[i]);
                            yDown.push(throughput[ip].down[i]);
                            counter++;
                        }
                        for (let i=0; i<throughput_head; i++) {
                            xUp.push(counter);
                            xDown.push(counter);
                            yUp.push(0.0 - throughput[ip].up[i]);
                            yDown.push(throughput[ip].down[i]);
                            counter++;
                        }

                        // Build the quantiles graph
                        if (circuit_info != null) {
                            for (let i=0; i<yDown.length; i++) {
                                let down = yDown[i];
                                let up = 0.0 - yUp[i];
                                let down_slot = Math.floor((down / circuit_info.capacity[0]) * 10.0);
                                let up_slot = Math.floor((up / circuit_info.capacity[1]) * 10.0);
                                if (down_slot > 0) quantiles[0][down_slot] += 1;
                                if (up_slot > 0) quantiles[1][up_slot] += 1;
                            }
                        }

                        let xd = zip(xDown, xUp);
                        let yd = zip(yDown.reverse(), yUp.reverse());

                        graph_data.push({x: xd, y: yd, name: ip + " Down", mode: 'markers', type: 'scatter', marker: { size: 4 }});
                        //graph_data.push({x: xUp, y: yUp.reverse(), name: ip + " Up", mode: 'markers', type: 'scatter'});
                    }
                    Plotly.newPlot(graph, graph_data, { margin: { l:0,r:0,b:0,t:0,pad:4 }, yaxis: { automargin: true, title: "Traffic (bits)" }, xaxis: {automargin: true, title: "Time since now (seconds)"} });
                    throughput_head += 1;
                    if (throughput_head >= 300) {
                        throughput_head = 0;
                    }
                    
                    graph = document.getElementById("capacityQuantile");
                    graph_data = [
                        {x: quantiles[2], y: quantiles[0], name: 'Download', type: 'bar'},
                        {x: quantiles[2], y: quantiles[1], name: 'Upload', type: 'bar'},
                    ];
                    Plotly.newPlot(graph, graph_data, { margin: { l:0,r:0,b:0,t:0,pad:4 }, yaxis: { automargin: true, title: '# Samples' }, xaxis: {automargin: true, title: '% Utilization'} });
                });
            }
        }

        let funnels = new MultiRingBuffer(300);
        let rtts = {};
        let circuitId = "";

        function getFunnel(c) {
            circuitId = encodeURI(c);
            $.get("/api/funnel_for_queue/" + circuitId, (data) => {
                let html = "";
                for (let i=0; i<data.length; ++i) {
                    funnels.push(data[i][0], data[i][1].current_throughput[0]*8, data[i][1].current_throughput[1]*8);
                    rtts[data[i][0]] = new RttHistogram();

                    let row = "<div class='row row220'>";

                    row += "<div class='col-sm-6'>";
                    row += "<div class='card bg-light'>";
                    row += "<h5 class='card-title'><i class='fa fa-hourglass'></i> <a class='redact' href='/tree?parent=" + data[i][0] + "'>" + redactText(data[i][1].name) + " Throughput</a></h5>";
                    row += "<div id='tp" + data[i][0] + "' class='graph98 graph150'></div>";
                    row += "</div>";
                    row += "</div>";

                    row += "<div class='col-sm-6'>";
                    row += "<div class='card bg-light'>";
                    row += "<h5 class='card-title redact'><i class='fa fa-bar-chart'></i> " + redactText(data[i][1].name) + " TCP RTT</h5>";
                    row += "<div id='rtt" + data[i][0] + "' class='graph98 graph150'></div>";
                    row += "</div>";
                    row += "</div>";

                    row += "</div>";
                    html += row;
                }             
                $("#pills-funnel").html(html);
                setTimeout(plotFunnels, 1000);
            });
        }

        function plotFunnels() {
            $.get("/api/funnel_for_queue/" + encodeURI(circuitId), (data) => {
                for (let i=0; i<data.length; ++i) {
                    funnels.push(data[i][0], data[i][1].current_throughput[0]*8, data[i][1].current_throughput[1]*8);
                    for (const [k, v] of Object.entries(funnels.data)) {
                        let target_div = "tp" + k;
                        let graphData = v.toScatterGraphData();
                        let graph = document.getElementById(target_div);
                        Plotly.newPlot(graph, graphData, { margin: { l:0,r:0,b:0,t:0,pad:4 }, yaxis: { automargin: true }, xaxis: {automargin: true, title: "Time since now (seconds)"} }, { responsive: true });
                    }

                    rtts[data[i][0]].clear();
                    for (let j=0; j<data[i][1].rtts.length; j++) {
                        rtts[data[i][0]].push(data[i][1].rtts[j]);
                    }
                    rtts[data[i][0]].plot("rtt" + data[i][0]);
                }
            });
        }

        function icmpType(n) {
            switch (n) {
                case 0: return "ECHO REPLY";
                case 3: return "DESTINATION UNREACHABLE";
                case 4: return "SOURCE QUENCH";
                case 8: return "ECHO REQUEST";
                case 11: return "TIME EXCEEDED";
                case 12: return "PARAMETER PROBLEM";
                case 13: return "TIMESTAMP REQUEST";
                case 14: return "TIMESTAMP REPLY";
                case 15: return "INFO REQUEST";
                case 16: return "INFO REPLY";
                case 17: return "ADDRESS REQUEST";
                case 18: return "ADDRESS REPLY";
                default: return "?";
            }
        }

        var madeButtons = false;
        var analysisId = null;
        var analysisTimer = null;
        var analysisBtn = null;

        function analyze(id) {
            if (analysisId != null) {
                alert("Heimdall says: 'STOP CLICKING ME'");
                return;
            }
            let ip = ips[id];
            $.get("/api/request_analysis/" + encodeURI(ip), (data) => {
                if (data == "Fail") {
                    alert("Heimdall is busy serving other customers. Your desire is important to him, please try again later.")
                    return;
                }
                analysisId = data.Ok.session_id;
                analysisBtn = "#dumpBtn_" + id;
                analysisTimer = data.Ok.countdown;
                analyzeTick();
            });
        }

        function analyzeTick() {
            $(analysisBtn).text("Gathering Data for " + analysisTimer + " more seconds");
            analysisTimer--;
            if (analysisTimer > -1) {
                setTimeout(analyzeTick, 1000);
            } else {
                window.location.href = "/ip_dump?id=" + analysisId + "&circuit_id=" + encodeURI(id);
            }
        }

        function getFlows() {
            let ip_list = "";
            let ip_btns = "";
            for (let i=0; i<ips.length; ++i) {
                ip_list += ips[i] + ",";
                if (circuit_info != null) {
                    ip_btns += "<a id='dumpBtn_" + i + "' href='#' onclick='analyze(\"" + i + "\")' class='btn btn-info'><i class='fa fa-search'></i> Analyze: " + ips[i] + "</a> "
                }
            }
            if (!madeButtons && ips.length > 0 && circuit_info != null) {
                ip_btns += "<br />";
                madeButtons = true;
                $("#packetButtons").html(ip_btns);
            }
            ip_list = ip_list.substring(0, ip_list.length-1);
            if (ip_list == "") return;
            $.get("/api/flows/" + ip_list, (data) => {
                //console.log(data);
                let html = "<table class='table table-striped'>";
                html += "<thead>";
                html += "<th>Protocol</th>";
                html += "<th>Src</th>";
                html += "<th>Src Port</th>";
                html += "<th>Dst</th>";
                html += "<th>Dst Port</th>";
                html += "<th>Pkt In</th>";
                html += "<th>Pkt Out</th>";
                html += "<th>Bytes In</th>";
                html += "<th>Bytes Out</th>";
                html += "<th>DSCP In</th>";
                html += "<th>DSCP Out</th>";
                html += "<th>ECN In</th>";
                html += "<th>ECN Out</th>";
                html += "</thead>";
                for (let i=0; i<data.length; i++) {
                    let rpackets = "-";
                    let rbytes = "-";
                    let rdscp = "-";
                    let rcongestion = "-";
                    if (data[i][1] != null) {
                        rpackets = data[i][1].packets;
                        rbytes = scaleNumber(data[i][1].bytes);
                        rdscp = "0x" + data[i][1].dscp.toString(16);
                        rcongestion = ecn(data[i][1].ecn);
                    }
                    html += "<tr>";
                    html += "<td>" + data[i][0].proto + "</td>";
                    html += "<td>" + data[i][0].src + "</td>";
                    if (data[i][0].proto == "ICMP") {
                        html += "<td>" + icmpType(data[i][0].src_port) + "</td>";
                    } else {
                        html += "<td>" + data[i][0].src_port + "</td>";
                    }
                    html += "<td>" + data[i][0].dst + "</td>";
                    if (data[i][0].proto == "ICMP") {
                        if (data[i][1] != null) {
                            html += "<td>" + icmpType(data[i][1].src_port) + "</td>";
                        } else {
                            html += "<td></td>";
                        }
                    } else {
                        html += "<td>" + data[i][0].dst_port + "</td>";
                    }
                    html += "<td>" + data[i][0].packets + "</td>";
                    html += "<td>" + rpackets + "</td>";
                    html += "<td>" + scaleNumber(data[i][0].bytes) + "</td>";
                    html += "<td>" + rbytes + "</td>";
                    html += "<td>0x" + data[i][0].dscp.toString(16) + "</td>";
                    html += "<td>" + rdscp + "</td>";
                    html += "<td>" + ecn(data[i][0].ecn) + "</td>";
                    html += "<td>" + rcongestion + "</td>";
                    html += "</tr>";
                }
                html += "</tbody></table>";
                $("#flowList").html(html);
            })
        }

        let id = 0;

        function oneSecondCadence() {
            pollQueue();
            getThroughput();
            getFunnel(id);
            getFlows();
            setTimeout(oneSecondCadence, 1000);
        }

        function start() {
            colorReloadButton();
            updateHostCounts();
            const params = new Proxy(new URLSearchParams(window.location.search), {
                get: (searchParams, prop) => searchParams.get(prop),
            });
            id = params.id;
            $.get("/api/watch_circuit/" + params.id, () => {
                oneSecondCadence();
                pollQueue();
                getThroughput();
                getFunnel(params.id);
                getFlows();
            });
        }

        $(document).ready(start);
    </script>

</body>
</html>
